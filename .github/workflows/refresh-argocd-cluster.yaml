# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ğŸ”„ Refresh ArgoCD Cluster Credentials
# Periodic credential refresh for spoke clusters registered with ArgoCD
# Prevents "Unknown" sync status due to expired tokens
# Generated by Opsera Code-to-Cloud v4.0
# Learning: SKILL-HUB-SPOKE-001
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
name: "ğŸ”„ Refresh ArgoCD Cluster"

on:
  workflow_dispatch:
    inputs:
      cluster_name:
        description: 'Spoke cluster to refresh'
        required: true
        default: 'opsera-usw2-np'
        type: string
      force_refresh:
        description: 'Force refresh even if cluster appears healthy'
        required: false
        default: false
        type: boolean
  # Uncomment for automatic weekly refresh:
  # schedule:
  #   - cron: '0 0 * * 0'  # Every Sunday at midnight

env:
  HUB_CLUSTER: argocd-usw2
  AWS_REGION: us-west-2

jobs:
  check-health:
    name: "ğŸ” Check Cluster Health"
    runs-on: ubuntu-latest
    outputs:
      needs_refresh: ${{ steps.check.outputs.needs_refresh }}
      cluster_status: ${{ steps.check.outputs.status }}
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Connect to Hub Cluster
        run: aws eks update-kubeconfig --name ${{ env.HUB_CLUSTER }} --region ${{ env.AWS_REGION }}

      - name: Check Cluster Connection Health
        id: check
        run: |
          CLUSTER_NAME="${{ github.event.inputs.cluster_name || 'opsera-usw2-np' }}"
          
          echo "ğŸ” Checking health of cluster: $CLUSTER_NAME"
          
          # Check if cluster secret exists
          if ! kubectl get secret -n argocd | grep -q "$CLUSTER_NAME"; then
            echo "âŒ Cluster secret not found!"
            echo "needs_refresh=true" >> $GITHUB_OUTPUT
            echo "status=not_found" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Check applications targeting this cluster
          UNKNOWN_COUNT=$(kubectl get applications -n argocd -o json | \
            jq -r --arg cluster "$CLUSTER_NAME" \
            '.items[] | select(.spec.destination.name == $cluster) | select(.status.sync.status == "Unknown") | .metadata.name' | wc -l)
          
          if [ "$UNKNOWN_COUNT" -gt 0 ]; then
            echo "âš ï¸ Found $UNKNOWN_COUNT applications with Unknown status"
            echo "needs_refresh=true" >> $GITHUB_OUTPUT
            echo "status=unhealthy" >> $GITHUB_OUTPUT
          elif [ "${{ github.event.inputs.force_refresh }}" = "true" ]; then
            echo "ğŸ”„ Force refresh requested"
            echo "needs_refresh=true" >> $GITHUB_OUTPUT
            echo "status=force" >> $GITHUB_OUTPUT
          else
            echo "âœ… Cluster appears healthy"
            echo "needs_refresh=false" >> $GITHUB_OUTPUT
            echo "status=healthy" >> $GITHUB_OUTPUT
          fi

  refresh-credentials:
    name: "ğŸ”„ Refresh Credentials"
    runs-on: ubuntu-latest
    needs: check-health
    if: needs.check-health.outputs.needs_refresh == 'true'
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install ArgoCD CLI
        run: |
          curl -sSL -o argocd https://github.com/argoproj/argo-cd/releases/latest/download/argocd-linux-amd64
          chmod +x argocd
          sudo mv argocd /usr/local/bin/
          argocd version --client

      - name: Connect to Hub Cluster
        run: aws eks update-kubeconfig --name ${{ env.HUB_CLUSTER }} --region ${{ env.AWS_REGION }}

      - name: Get ArgoCD Server URL
        id: argocd-server
        run: |
          # Try LoadBalancer first, then ClusterIP with port-forward
          ARGOCD_SERVER=$(kubectl get svc argocd-server -n argocd -o jsonpath='{.status.loadBalancer.ingress[0].hostname}' 2>/dev/null || echo "")
          
          if [ -z "$ARGOCD_SERVER" ]; then
            # Use kubectl port-forward in background
            kubectl port-forward svc/argocd-server -n argocd 8443:443 &
            sleep 5
            ARGOCD_SERVER="localhost:8443"
          fi
          
          echo "server=$ARGOCD_SERVER" >> $GITHUB_OUTPUT
          echo "âœ… ArgoCD Server: $ARGOCD_SERVER"

      - name: Login to ArgoCD
        run: |
          # Get admin password
          ARGOCD_PASSWORD=$(kubectl get secret argocd-initial-admin-secret -n argocd \
            -o jsonpath='{.data.password}' 2>/dev/null | base64 -d || echo "")
          
          if [ -z "$ARGOCD_PASSWORD" ]; then
            echo "âŒ Could not retrieve ArgoCD admin password"
            echo "The initial admin secret may have been deleted"
            echo "Manual credential refresh required"
            exit 1
          fi
          
          argocd login ${{ steps.argocd-server.outputs.server }} \
            --username admin \
            --password "$ARGOCD_PASSWORD" \
            --insecure
          
          echo "âœ… Logged in to ArgoCD"

      - name: Backup Current Cluster Config
        run: |
          CLUSTER_NAME="${{ github.event.inputs.cluster_name || 'opsera-usw2-np' }}"
          
          echo "ğŸ“¦ Backing up current cluster configuration..."
          kubectl get secret "$CLUSTER_NAME" -n argocd -o yaml > /tmp/cluster-backup.yaml 2>/dev/null || true
          
          echo "Current cluster info:"
          argocd cluster get "$CLUSTER_NAME" 2>/dev/null || echo "Cluster info not available"

      - name: Refresh Cluster Credentials
        run: |
          CLUSTER_NAME="${{ github.event.inputs.cluster_name || 'opsera-usw2-np' }}"
          
          echo "ğŸ”„ Refreshing credentials for cluster: $CLUSTER_NAME"
          
          # Get fresh kubeconfig for spoke cluster
          aws eks update-kubeconfig --name "$CLUSTER_NAME" --region ${{ env.AWS_REGION }} --alias "$CLUSTER_NAME"
          
          # Get the context name
          CONTEXT_NAME="$CLUSTER_NAME"
          
          # Remove existing cluster registration
          echo "ğŸ—‘ï¸ Removing existing cluster registration..."
          argocd cluster rm "$CLUSTER_NAME" --yes 2>/dev/null || echo "Cluster not found (first time registration)"
          
          # Re-add cluster with fresh credentials
          echo "ğŸ†• Adding cluster with fresh credentials..."
          argocd cluster add "$CONTEXT_NAME" --name "$CLUSTER_NAME" --yes
          
          echo "âœ… Cluster credentials refreshed"

      - name: Verify New Credentials
        run: |
          CLUSTER_NAME="${{ github.event.inputs.cluster_name || 'opsera-usw2-np' }}"
          
          echo "ğŸ” Verifying new credentials..."
          
          # Check cluster appears in list
          argocd cluster list | grep "$CLUSTER_NAME"
          
          # Wait and check if applications start syncing
          echo "â³ Waiting for applications to start syncing..."
          sleep 30
          
          # Check applications targeting this cluster
          kubectl get applications -n argocd -o json | \
            jq -r --arg cluster "$CLUSTER_NAME" \
            '.items[] | select(.spec.destination.name == $cluster) | "\(.metadata.name): \(.status.sync.status) / \(.status.health.status)"'

  verify-applications:
    name: "âœ… Verify Applications"
    runs-on: ubuntu-latest
    needs: [check-health, refresh-credentials]
    if: always() && needs.refresh-credentials.result == 'success'
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Connect to Hub Cluster
        run: aws eks update-kubeconfig --name ${{ env.HUB_CLUSTER }} --region ${{ env.AWS_REGION }}

      - name: Check Application Sync Status
        run: |
          CLUSTER_NAME="${{ github.event.inputs.cluster_name || 'opsera-usw2-np' }}"
          
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“Š APPLICATION STATUS AFTER REFRESH"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          # Get all applications targeting this cluster
          kubectl get applications -n argocd -o json | \
            jq -r --arg cluster "$CLUSTER_NAME" \
            '.items[] | select(.spec.destination.name == $cluster) | "\(.metadata.name) | Sync: \(.status.sync.status) | Health: \(.status.health.status)"'
          
          # Count status
          SYNCED=$(kubectl get applications -n argocd -o json | \
            jq -r --arg cluster "$CLUSTER_NAME" \
            '[.items[] | select(.spec.destination.name == $cluster) | select(.status.sync.status == "Synced")] | length')
          
          UNKNOWN=$(kubectl get applications -n argocd -o json | \
            jq -r --arg cluster "$CLUSTER_NAME" \
            '[.items[] | select(.spec.destination.name == $cluster) | select(.status.sync.status == "Unknown")] | length')
          
          echo ""
          echo "ğŸ“Š Summary:"
          echo "  âœ… Synced: $SYNCED"
          echo "  âš ï¸ Unknown: $UNKNOWN"
          
          if [ "$UNKNOWN" -gt 0 ]; then
            echo ""
            echo "âš ï¸ Some applications still show Unknown status"
            echo "This may require manual investigation"
          fi

  summary:
    name: "ğŸ“‹ Summary"
    runs-on: ubuntu-latest
    needs: [check-health, refresh-credentials, verify-applications]
    if: always()
    steps:
      - name: Display Summary
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘  ğŸ”„ ARGOCD CLUSTER REFRESH SUMMARY                                               â•‘"
          echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
          echo "â•‘  Cluster:        ${{ github.event.inputs.cluster_name || 'opsera-usw2-np' }}"
          echo "â•‘  Initial Status: ${{ needs.check-health.outputs.cluster_status }}"
          echo "â•‘  Refresh:        ${{ needs.refresh-credentials.result }}"
          echo "â•‘  Verification:   ${{ needs.verify-applications.result }}"
          echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
          echo "â•‘  ğŸ”— Learning: SKILL-HUB-SPOKE-001                                                â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
