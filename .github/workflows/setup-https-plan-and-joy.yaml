# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ğŸ”’ HTTPS Setup - Plan & Joy
# Configure Route53 DNS and verify cert-manager TLS
# Generated by Opsera Code-to-Cloud v4.0
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
name: "ğŸ”’ HTTPS - plan-and-joy"

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'dev'
        type: string

env:
  APP_NAME: plan-and-joy
  TENANT: opsera
  AWS_REGION: us-west-2
  ENVIRONMENT: ${{ github.event.inputs.environment || 'dev' }}
  SPOKE_CLUSTER: opsera-usw2-np
  DOMAIN: agent.opsera.dev

concurrency:
  group: https-${{ github.event.inputs.environment || 'dev' }}
  cancel-in-progress: false

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Job 1: Setup Route53 DNS
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  setup-dns:
    name: "ğŸŒ Setup DNS"
    runs-on: ubuntu-latest
    outputs:
      subdomain: ${{ steps.dns.outputs.subdomain }}
      lb_hostname: ${{ steps.lb.outputs.hostname }}
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Connect to Spoke Cluster
        run: |
          aws eks update-kubeconfig --name ${{ env.SPOKE_CLUSTER }} --region ${{ env.AWS_REGION }}
          kubectl cluster-info

      - name: Get LoadBalancer Hostname
        id: lb
        run: |
          echo "â³ Waiting for ingress LoadBalancer..."
          MAX_ATTEMPTS=30
          ATTEMPT=1

          while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
            LB_HOSTNAME=$(kubectl get ingress ${{ env.APP_NAME }} \
              -n ${{ env.APP_NAME }}-${{ env.ENVIRONMENT }} \
              -o jsonpath='{.status.loadBalancer.ingress[0].hostname}' 2>/dev/null || echo "")

            if [ -n "$LB_HOSTNAME" ]; then
              echo "âœ… LoadBalancer hostname: $LB_HOSTNAME"
              echo "hostname=$LB_HOSTNAME" >> $GITHUB_OUTPUT
              exit 0
            fi

            echo "[$ATTEMPT/$MAX_ATTEMPTS] Waiting for LoadBalancer..."
            sleep 10
            ATTEMPT=$((ATTEMPT + 1))
          done

          echo "âŒ LoadBalancer not ready after 5 minutes"
          exit 1

      - name: Create Route53 DNS Record
        id: dns
        run: |
          SUBDOMAIN="${{ env.TENANT }}-${{ env.APP_NAME }}-${{ env.ENVIRONMENT }}.${{ env.DOMAIN }}"
          LB_HOSTNAME="${{ steps.lb.outputs.hostname }}"

          echo "ğŸ“ Creating DNS record: $SUBDOMAIN -> $LB_HOSTNAME"

          # Get hosted zone ID
          ZONE_ID=$(aws route53 list-hosted-zones-by-name \
            --dns-name "${{ env.DOMAIN }}" \
            --query "HostedZones[0].Id" \
            --output text | sed 's|/hostedzone/||')

          if [ -z "$ZONE_ID" ] || [ "$ZONE_ID" = "None" ]; then
            echo "âŒ Hosted zone not found for ${{ env.DOMAIN }}"
            echo "âš ï¸ Please create DNS record manually"
            exit 0
          fi

          # Create/update DNS record
          aws route53 change-resource-record-sets \
            --hosted-zone-id "$ZONE_ID" \
            --change-batch "{
              \"Changes\": [{
                \"Action\": \"UPSERT\",
                \"ResourceRecordSet\": {
                  \"Name\": \"$SUBDOMAIN\",
                  \"Type\": \"CNAME\",
                  \"TTL\": 300,
                  \"ResourceRecords\": [{\"Value\": \"$LB_HOSTNAME\"}]
                }
              }]
            }"

          echo "âœ… DNS record created: $SUBDOMAIN"
          echo "subdomain=$SUBDOMAIN" >> $GITHUB_OUTPUT

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Job 2: Verify TLS Certificate
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  verify-tls:
    name: "ğŸ” Verify TLS"
    runs-on: ubuntu-latest
    needs: setup-dns
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Connect to Spoke Cluster
        run: |
          aws eks update-kubeconfig --name ${{ env.SPOKE_CLUSTER }} --region ${{ env.AWS_REGION }}

      - name: Check cert-manager Certificate
        run: |
          echo "â³ Waiting for TLS certificate..."
          MAX_ATTEMPTS=24
          ATTEMPT=1

          while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
            CERT_READY=$(kubectl get certificate ${{ env.APP_NAME }}-${{ env.ENVIRONMENT }}-tls \
              -n ${{ env.APP_NAME }}-${{ env.ENVIRONMENT }} \
              -o jsonpath='{.status.conditions[?(@.type=="Ready")].status}' 2>/dev/null || echo "False")

            if [ "$CERT_READY" = "True" ]; then
              echo "âœ… TLS certificate is ready!"
              kubectl get certificate -n ${{ env.APP_NAME }}-${{ env.ENVIRONMENT }}
              exit 0
            fi

            echo "[$ATTEMPT/$MAX_ATTEMPTS] Certificate status: $CERT_READY"
            sleep 10
            ATTEMPT=$((ATTEMPT + 1))
          done

          echo "âš ï¸ Certificate not ready yet - may take a few more minutes"
          kubectl describe certificate ${{ env.APP_NAME }}-${{ env.ENVIRONMENT }}-tls \
            -n ${{ env.APP_NAME }}-${{ env.ENVIRONMENT }} || true

      - name: Verify HTTPS Endpoint
        run: |
          SUBDOMAIN="${{ needs.setup-dns.outputs.subdomain }}"
          echo "ğŸ” Testing HTTPS endpoint: https://$SUBDOMAIN"

          sleep 30  # Wait for DNS propagation

          MAX_ATTEMPTS=6
          ATTEMPT=1

          while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
            HTTP_STATUS=$(curl -sSo /dev/null -w "%{http_code}" "https://$SUBDOMAIN" --max-time 10 2>/dev/null || echo "000")

            if [ "$HTTP_STATUS" = "200" ]; then
              echo "âœ… HTTPS endpoint is live! Status: $HTTP_STATUS"
              exit 0
            fi

            echo "[$ATTEMPT/$MAX_ATTEMPTS] HTTP Status: $HTTP_STATUS"
            sleep 30
            ATTEMPT=$((ATTEMPT + 1))
          done

          echo "âš ï¸ HTTPS verification incomplete - endpoint may need more time"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Job 3: Summary
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  summary:
    name: "ğŸ“‹ HTTPS Summary"
    runs-on: ubuntu-latest
    needs: [setup-dns, verify-tls]
    if: always()
    steps:
      - name: Display HTTPS Summary
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘  ğŸ”’ HTTPS SETUP COMPLETE - Plan & Joy                                        â•‘"
          echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
          echo "â•‘  App:         ${{ env.APP_NAME }}"
          echo "â•‘  Environment: ${{ env.ENVIRONMENT }}"
          echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
          echo "â•‘  ğŸŒ Live URL:                                                                â•‘"
          echo "â•‘     https://${{ needs.setup-dns.outputs.subdomain }}"
          echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
          echo "â•‘  ğŸ“Š Job Results:                                                             â•‘"
          echo "â•‘  â”œâ”€ DNS Setup:    ${{ needs.setup-dns.result }}"
          echo "â•‘  â””â”€ TLS Verify:   ${{ needs.verify-tls.result }}"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ¦ Powered by Opsera Code-to-Cloud v4.0"
