# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ğŸš€ Bootstrap QA Environment - Plan & Joy
# One-time setup for QA environment with ArgoCD
# Generated by Opsera Code-to-Cloud v4.0
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
name: "ğŸš€ Bootstrap QA - plan-and-joy"

on:
  workflow_dispatch:

env:
  APP_NAME: plan-and-joy
  TENANT: opsera
  AWS_REGION: us-west-2
  ENVIRONMENT: qa
  DOMAIN: agent.opsera.dev
  HUB_CLUSTER: argocd-usw2

jobs:
  bootstrap-qa:
    name: "ğŸš€ Bootstrap QA Environment"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_PAT }}

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Get ECR URI
        id: ecr
        run: |
          AWS_ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          ECR_URI="${AWS_ACCOUNT_ID}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/${{ env.TENANT }}/${{ env.APP_NAME }}"
          echo "uri=$ECR_URI" >> $GITHUB_OUTPUT
          echo "âœ… ECR URI: $ECR_URI"

      - name: Update QA Kustomization with ECR URI
        run: |
          KUSTOMIZE_FILE=".opsera-${{ env.APP_NAME }}/k8s/overlays/${{ env.ENVIRONMENT }}/kustomization.yaml"
          ECR_URI="${{ steps.ecr.outputs.uri }}"
          
          sed -i "s|PLACEHOLDER_ECR_URI|$ECR_URI|" "$KUSTOMIZE_FILE"
          
          echo "âœ… Updated kustomization with ECR URI"
          cat "$KUSTOMIZE_FILE"

      - name: Connect to Hub Cluster
        run: aws eks update-kubeconfig --name ${{ env.HUB_CLUSTER }} --region ${{ env.AWS_REGION }}

      - name: Create QA Namespace
        run: |
          kubectl create namespace ${{ env.APP_NAME }}-${{ env.ENVIRONMENT }} --dry-run=client -o yaml | kubectl apply -f -
          echo "âœ… Namespace created: ${{ env.APP_NAME }}-${{ env.ENVIRONMENT }}"

      - name: Create ArgoCD Application
        run: |
          kubectl apply -f .opsera-${{ env.APP_NAME }}/argocd/application-qa.yaml
          echo "âœ… ArgoCD application created for QA"

      - name: Setup DNS Record
        run: |
          HOSTED_ZONE_ID=$(aws route53 list-hosted-zones-by-name --dns-name "${{ env.DOMAIN }}" --query "HostedZones[0].Id" --output text | cut -d'/' -f3)
          
          # Get the LoadBalancer hostname
          LB_HOSTNAME=$(kubectl get svc -n ingress-nginx ingress-nginx-controller -o jsonpath='{.status.loadBalancer.ingress[0].hostname}' 2>/dev/null || echo "")
          
          if [ -n "$LB_HOSTNAME" ]; then
            SUBDOMAIN="${{ env.TENANT }}-${{ env.APP_NAME }}-${{ env.ENVIRONMENT }}"
            
            aws route53 change-resource-record-sets --hosted-zone-id "$HOSTED_ZONE_ID" --change-batch '{
              "Changes": [{
                "Action": "UPSERT",
                "ResourceRecordSet": {
                  "Name": "'"$SUBDOMAIN.${{ env.DOMAIN }}"'",
                  "Type": "CNAME",
                  "TTL": 300,
                  "ResourceRecords": [{"Value": "'"$LB_HOSTNAME"'"}]
                }
              }]
            }'
            echo "âœ… DNS record created: $SUBDOMAIN.${{ env.DOMAIN }} â†’ $LB_HOSTNAME"
          else
            echo "âš ï¸ LoadBalancer not ready - DNS will be configured after first deployment"
          fi

      - name: Commit Kustomization Update
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add .opsera-${{ env.APP_NAME }}/k8s/overlays/${{ env.ENVIRONMENT }}/kustomization.yaml
          
          if ! git diff --staged --quiet; then
            git commit -m "chore: configure QA environment with ECR URI [skip ci]"
            git push origin main
          fi

      - name: Display Bootstrap Summary
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘  ğŸš€ QA ENVIRONMENT BOOTSTRAPPED                                                  â•‘"
          echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
          echo "â•‘  App:         ${{ env.APP_NAME }}"
          echo "â•‘  Environment: ${{ env.ENVIRONMENT }}"
          echo "â•‘  Namespace:   ${{ env.APP_NAME }}-${{ env.ENVIRONMENT }}"
          echo "â•‘  ECR URI:     ${{ steps.ecr.outputs.uri }}"
          echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
          echo "â•‘  ğŸ“‹ Next Steps:                                                                  â•‘"
          echo "â•‘  1. Run the Canary Deploy workflow to deploy to QA                               â•‘"
          echo "â•‘  2. Or run CI/CD workflow with environment=qa                                    â•‘"
          echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
          echo "â•‘  ğŸŒ QA URL (after deployment):                                                   â•‘"
          echo "â•‘     https://${{ env.TENANT }}-${{ env.APP_NAME }}-${{ env.ENVIRONMENT }}.${{ env.DOMAIN }}"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
